System.register([],(function(){"use strict";return{execute:function(){function t(t,e,i,s,n,r){let a;const o=e=>{t.removeEventListener("click",o),a()};e.save();const l=i/30;e.fillStyle="#000000cc",e.fillRect(l,l,i-2*l,s-2*l);const h=n.split("\n");e.textBaseline="top",e.textAlign="left",e.fillStyle="white",e.font=`${r}px monospace`;let c=0;for(let t of h){let s=t.length;for(;t;){if(" "===t[0]&&(t=t.slice(1)),e.measureText(t.slice(0,s)).width<=i-4*l){e.fillText(t.slice(0,s),2*l,2*l+1.2*r*c),t=t.slice(s),s=t.length,c++;continue}s--;let n=t.slice(0,s).lastIndexOf(" ");-1!==n&&(s=n)}}return e.textAlign="center",e.fillText("(click anywhere to continue)",i/2,2*l+1.2*r*(c+2)),e.restore(),new Promise(e=>{a=e,t.addEventListener("click",o)})}function e(t){return t>=520?15:t>=450?13:t>=420?12:t>=320?9:6}function i(){return!("ontouchstart"in document.documentElement||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)}class s{constructor(t,e,i){this.ctx=t,this.containerWidth=e,this.containerHeight=i,this._active=!1,this._options=[],this._beforeRedraw=null,this._renderedOptions=[],this._selectedOption=-1,this._listeners=[]}addOption(t,e){this._options.push({text:t,callback:e}),this._prepare()}addOptions(t){for(const e of t)this.addOption(e.text,e.callback)}_prepare(){const t=function(t){return t>=420?24:t>=320?20:16}(this.containerWidth);this.ctx.save(),this.ctx.font=`${t}px monospace`,this.ctx.textBaseline="middle",this.ctx.textAlign="center";const e=this._options.reduce((t,e)=>t.text.length>e.text.length?t:e),i=1.4*this.ctx.measureText(e.text,this.containerWidth/2,this.containerHeight/2).width,s=2.4*t,n=this.containerHeight/this._options.length;if(n<1.2*s)throw this.ctx.restore(),new Error("Too many options don't fit in container");this._renderedOptions=[];for(let e=0;e<this._options.length;e++)this._renderedOptions.push({button:{x:this.containerWidth/2-i/2,y:n*(e+.5)-s/2,width:i,height:s},label:{text:this._options[e].text,size:t,x:this.containerWidth/2,y:n*(e+.5)},callback:this._options[e].callback});this.ctx.restore()}_draw(){this._beforeRedraw?this._beforeRedraw():this.ctx.clearRect(0,0,this.containerWidth,this.containerHeight),this.ctx.save(),this.ctx.textBaseline="middle",this.ctx.textAlign="center";for(let t=0;t<this._renderedOptions.length;t++){const e=this._renderedOptions[t];this.ctx.fillStyle=i()&&t===this._selectedOption?"#1f295d":"#0f1743",this.ctx.fillRect(e.button.x,e.button.y,e.button.width,e.button.height),this.ctx.fillStyle="white",this.ctx.font=`${e.label.size}px monospace`,this.ctx.fillText(e.label.text,e.label.x,e.label.y)}this.ctx.restore()}set onBeforeRedraw(t){this._beforeRedraw=t}_clickHandler(t){-1!==this._selectedOption&&this._renderedOptions[this._selectedOption].callback()}_mousemoveHandler(t){let e=-1;for(let i=0;i<this._renderedOptions.length;i++){const s=this._renderedOptions[i];if(t.offsetX>=s.button.x&&t.offsetX<=s.button.x+s.button.width&&t.offsetY>=s.button.y&&t.offsetY<=s.button.y+s.button.height){e=i;break}}this._selectedOption!==e&&(this._selectedOption=e,this._draw.call(this))}_installHandlers(){const t={on:"click",fn:this._clickHandler.bind(this)},e={on:"mousemove",fn:this._mousemoveHandler.bind(this)};this._listeners.push(t),this._listeners.push(e),this.ctx.canvas.addEventListener("click",t.fn),this.ctx.canvas.addEventListener("mousemove",e.fn)}_removeHandlers(){for(const t of this._listeners)this.ctx.canvas.removeEventListener(t.on,t.fn);this._listeners=[]}get active(){return this._active}activate(){this._installHandlers(),this._draw(),this._active=!0}deactivate(){this._removeHandlers(),this._active=!1}}function n(t,e,i,s,n,r,a){let o=0,l=0,h=!1;const c=e/7*(n+.5),d=i/6*(s+.5),u=3*i;return new Promise(i=>{const s=n=>{let f;0===o?(f=0,o=n):(f=n-o,o=n),l+=f/1e3*u,l>=d&&(l=d,h=!0),a(),function(t,e,i,s,n,r){t.save();const a=e/7/2-8,o=t.createRadialGradient(s-5,n-5,a/2.5,s,n,a);1===r?(o.addColorStop(0,"#2093ff"),o.addColorStop(1,"#1564ad")):(o.addColorStop(0,"#66e2d8"),o.addColorStop(1,"#4ba69f")),t.fillStyle=o,t.beginPath(),t.arc(s,n,a,0,2*Math.PI,!1),t.fill(),t.restore()}(t,e,0,c,l,r),h?i():requestAnimationFrame(s)};requestAnimationFrame(s)})}function r(t,e,i,s,n,r,a){t.save(),t.font=`${n}px monospace`,t.textBaseline="middle",t.textAlign="center",t.globalAlpha=.9,t.shadowBlur=4,t.shadowColor="rgba(0, 0, 0, 0.5)";const o=t.measureText(s,e/2,i/2);t.fillStyle=a,t.fillRect(e/2-o.width/2-10,i/2-n/2-10,o.width+20,n+20),t.globalAlpha=1,t.shadowBlur=2,t.shadowOffsetX=2,t.shadowOffsetY=2,t.fillStyle=r,t.fillText(s,e/2,i/2),t.restore()}class a{constructor(t,e,i){this.ctx=t,this.width=e,this.height=i,this.paused=!1,this._circles=[],this._selectedColumn=0,this._active=!0,this._firstTurn=1,this._currentTurn=1,this._noMoves=!1,this._winner={team:0,first:[],last:[]},this._listeners=[],this._animating=!1,this._animationWaiters=[],this._externalPlayer=0,this._externalPlayerFn=void 0;for(let t=0;t<6;t++){const t=[];for(let e=0;e<7;e++)t.push(0);this._circles.push(t)}}reset(){this._active=!0,this._currentTurn=1,this._noMoves=!1,this._winner={team:0,first:[],last:[]},this.animating=!1;for(let t=0,e=this._circles.length;t<e;t++)this._circles.pop();for(let t=0;t<6;t++){const t=[];for(let e=0;e<7;e++)t.push(0);this._circles.push(t)}}draw(){!function(t,e,i){t.save(),t.fillStyle="#ddebff",t.fillRect(0,0,e,i),t.restore()}(this.ctx,this.width,this.height),function(t,e,i){t.save();for(let s=1;s<7;s++)t.beginPath(),t.moveTo(e/7*s,0),t.lineTo(e/7*s,i),t.stroke(),t.closePath();for(let s=1;s<6;s++)t.beginPath(),t.moveTo(0,i/6*s),t.lineTo(e,i/6*s),t.stroke(),t.closePath();t.restore()}(this.ctx,this.width,this.height),!this.paused&&(this._active||this._animating)&&this._selectedColumn>0&&i()&&function(t,e,i,s){t.save();const n=e/7*(s-1),r=e/7,a=i,o=t.createLinearGradient(n,0,n+r,0);o.addColorStop(0,"rgba(255, 255, 255, 0.5)"),o.addColorStop(.4,"rgba(255, 255, 255, 0)"),o.addColorStop(.6,"rgba(255, 255, 255, 0)"),o.addColorStop(1,"rgba(255, 255, 255, 0.5)"),t.fillStyle=o,t.fillRect(n,0,r,a),t.restore()}(this.ctx,this.width,this.height,this._selectedColumn),function(t,e,i,s){t.save();for(let n=0;n<s.length;n++)for(let r=0;r<s[n].length;r++){if(!s[n][r])continue;const a=e/7*(r+.5),o=i/6*(n+.5),l=e/7/2-8,h=t.createRadialGradient(a-5,o-5,l/2.5,a,o,l);1===s[n][r]?(h.addColorStop(0,"#2093ff"),h.addColorStop(1,"#1564ad")):(h.addColorStop(0,"#66e2d8"),h.addColorStop(1,"#4ba69f")),t.fillStyle=h,t.beginPath(),t.arc(a,o,l,0,2*Math.PI,!1),t.fill()}t.restore()}(this.ctx,this.width,this.height,this._circles),this._winner.team?(function(t,e,i,s,n){t.save();const r=e/7*(s[1]+.5),a=i/6*(s[0]+.5),o=e/7*(n[1]+.5),l=i/6*(n[0]+.5);t.lineWidth=4,t.strokeStyle="#1564ad",t.beginPath(),t.moveTo(r,a),t.lineTo(o,l),t.stroke(),t.closePath(),t.restore()}(this.ctx,this.width,this.height,this._winner.first,this._winner.last),function(t,e,i,s){r(t,e,i,`Team ${s} wins!`,function(t){return t>=420?48:t>=320?32:24}(e),"white",1===s?"#1564ad":"#4ba69f")}(this.ctx,this.width,this.height,this._winner.team)):this.paused||function(t,i,s,n){t.save();const r=e(i);t.fillStyle="#222",t.font=`${r}px monospace`,t.textBaseline="top",t.textAlign="left";const a=t.measureText("Current turn: ",0,0).width;t.fillText("Current turn: ",4,4),t.fillStyle=1===n?"#1564ad":"#4ba69f",t.beginPath(),t.arc(a+r/2,r/2+4,r/2,0,2*Math.PI,!1),t.fill(),t.restore()}(this.ctx,this.width,this.height,this._currentTurn),this._noMoves&&r(this.ctx,this.width,this.height,"No moves left!",32,"white","black")}static getMoveRow(t,e){let i=-1;for(let s=t.length-1;s>=0;s--)if(!t[s][e]){i=s;break}return i}processMove(t){const e=a.getMoveRow(this._circles,t);-1!==e&&(this._active=!1,this.animating=!0,n(this.ctx,this.width,this.height,e,t,this._currentTurn,this.draw.bind(this)).then(()=>{this._circles[e][t]=this._currentTurn,this._currentTurn=1===this._currentTurn?2:1;const i=function(t){let e=[];for(let i=0;i<6;i++){let s=0,n=0;for(let r=0;r<7;r++)if(t[i][r]!==n?(s=1,e=[i,r],n=t[i][r]):0!=n&&s++,s>=4)return{team:n,first:e,last:[i,r]}}for(let i=0;i<7;i++){let s=0,n=0;for(let r=0;r<6;r++)if(t[r][i]!==n?(s=1,e=[r,i],n=t[r][i]):0!=n&&s++,s>=4)return{team:n,first:e,last:[r,i]}}for(let i=0;i<6;i++){let s=0,n=0;for(let r=0;r<=i&&r<=7;r++)if(t[i-r][r]!==n?(s=1,e=[i-r,r],n=t[i-r][r]):0!=n&&s++,s>=4)return{team:n,first:e,last:[i-r,r]};s=0,n=0;for(let r=0;r<=5-i&&r<=7;r++)if(t[i+r][6-r]!==n?(s=1,e=[i+r,6-r],n=t[i+r][6-r]):0!=n&&s++,s>=4)return{team:n,first:e,last:[i+r,6-r]}}for(let i=0;i<6;i++){let s=0,n=0;for(let r=0;r<=i&&r<=7;r++)if(t[i-r][6-r]!==n?(s=1,e=[i-r,6-r],n=t[i-r][6-r]):0!=n&&s++,s>=4)return{team:n,first:e,last:[i-r,6-r]};s=0,n=0;for(let r=0;r<=5-i&&r<=7;r++)if(t[i+r][r]!==n?(s=1,e=[i+r,r],n=t[i+r][r]):0!=n&&s++,s>=4)return{team:n,first:e,last:[i+r,r]}}return{team:0,first:[],last:[]}}(this._circles);i.team?this._winner=i:!function(t){for(let e=0;e<t.length;e++)for(let i=0;i<t[e].length;i++)if(0===t[e][i])return!0;return!1}(this._circles)?this._noMoves=!0:this._active=!0,this.animating=!1,this.draw(),this._active&&setTimeout(this.checkExternalPlayer.bind(this))}))}_clickHandler(t){if(!this.paused)return this._noMoves||this._winner.team?(this.reset.call(this),this._active=!0,this._currentTurn=1===this._firstTurn?2:1,this._firstTurn=this._currentTurn,this.draw.call(this),void setTimeout(this.checkExternalPlayer.bind(this))):void(this._active&&this.processMove.call(this,this._selectedColumn-1))}_mousemoveHandler(t){const e=Math.ceil(t.offsetX/(this.width/7));if(e!==this._selectedColumn){if(this._selectedColumn=e,!this._active&&!this.animating||this.paused)return;this.draw.call(this)}}_mouseleaveHandler(t){this._selectedColumn=0,this._active&&!this.paused&&this.draw.call(this)}installHandlers(){const t={on:"click",fn:this._clickHandler.bind(this)},e={on:"mousemove",fn:this._mousemoveHandler.bind(this)},i={on:"mouseleave",fn:this._mouseleaveHandler.bind(this)};this._listeners.push(t),this._listeners.push(e),this._listeners.push(i),this.ctx.canvas.addEventListener("click",t.fn),this.ctx.canvas.addEventListener("mousemove",e.fn),this.ctx.canvas.addEventListener("mouseleave",i.fn)}removeHandlers(){for(const t of this._listeners)this.ctx.canvas.removeEventListener(t.on,t.fn);this._listeners=[]}get animating(){return this._animating}set animating(t){if(this._animating=t,!t){for(const t of this._animationWaiters)t();this._animationWaiters=[]}}waitForAnimation(){return this.animating?new Promise(t=>{this._animationWaiters.push(t)}):Promise.resolve()}setExternalPlayer(t,e){this._externalPlayer=t,this._externalPlayerFn=e,this._active&&setTimeout(this.checkExternalPlayer.bind(this))}resetExternalPlayer(){this._externalPlayer=0,this._externalPlayerFn=void 0}checkExternalPlayer(){this._externalPlayer&&this._currentTurn===this._externalPlayer&&(this._active=!1,this.animating=!0,this._externalPlayerFn(function(t){const e=[];for(const i of t)e.push(i.slice());return e}(this._circles)).then(this.processMove.bind(this)))}}const o=document.getElementById("game"),l=document.getElementsByClassName("subcontainer")[0],h=o.getContext("2d"),c=window.devicePixelRatio||1;let d=l.clientWidth,u=d/7*6;o.width=d*c,o.height=u*c,1!==c&&(o.style.width=d+"px",o.style.height=u+"px",h.scale(c,c));let f=!1,v=!1;const _=new a(h,d,u);_.paused=!0,_.installHandlers();const m=t=>{const e=new Worker("./ai.js");e.postMessage(["setLevel",t]),_.setExternalPlayer(2,t=>new Promise(i=>{const s=t=>{"move"===t.data[0]&&(e.removeEventListener("message",s),i(t.data[1]))};e.addEventListener("message",s),e.postMessage(["move",t])}))},p=new s(h,d,u);p.addOptions([{text:"Easy",callback:()=>{m(4),p.deactivate(),v=!0,_.paused=!1,_.draw()}},{text:"Medium",callback:()=>{m(6),p.deactivate(),v=!0,_.paused=!1,_.draw()}},{text:"Hard",callback:()=>{m(8),p.deactivate(),v=!0,_.paused=!1,_.draw()}}]),p.onBeforeRedraw=_.draw.bind(_);const x=new s(h,d,u);x.addOptions([{text:"2 Players",callback:()=>{x.deactivate(),v=!0,_.paused=!1,_.draw()}},{text:"Player vs Computer",callback:()=>{x.deactivate(),p.activate()}}]),x.onBeforeRedraw=_.draw.bind(_);const w=new s(h,d,u);w.addOptions([{text:"Play!",callback:()=>{if(!v)return w.deactivate(),void x.activate();w.deactivate(),_.paused=!1,_.draw()}},{text:"Rules",callback:()=>{w.deactivate(),t(o,h,d,u,"Rules:\n \nEach player is represented by a color (blue or teal). The goal of the game is to get four connected pieces of your color into any row, column or diagonal. The players move in turns. Each turn the player can place one of their pieces into any of the seven columns where each piece will fall to the lowest possible free place i.e. it will fall down until it reaches the ground level or another piece.\n \nAfter one player's move is done the second player can make their input. This is repeated until the game is over, which is when one of the players has four pieces in a row, column or diagonal or no more moves are possible because the board is filled.\n",e(d)).then(()=>w.activate())}},{text:"Credits",callback:()=>{w.deactivate(),t(o,h,d,u,"Credits:\n \nThis game was created by Spring Raindrop. You can find the sources at https://github.com/cutiful/four-in-line.\n \nRules were copied from KFourInLine handbook.\n",e(d)).then(()=>w.activate())}},{text:"Save for offline",callback:()=>{w.deactivate();const i=()=>w.activate();"serviceWorker"in navigator?f||navigator.serviceWorker.controller?t(o,h,d,u,"You have already registered a service worker before. The game should work even if your internet cable is unplugged!",e(d)).then(i):navigator.serviceWorker.register("sw.js").then(s=>{f=!0,t(o,h,d,u,"Successfully installed a service worker! Now the game should work even if your internet cable is unplugged!",e(d)).then(i)}).catch(s=>{t(o,h,d,u,"Sorry, something went wrong! "+s.toString(),e(d)).then(i)}):t(o,h,d,u,"Sorry, your browser doesn't support service workers!",e(d)).then(i)}}]),w.onBeforeRedraw=_.draw.bind(_),w.activate(),document.addEventListener("keyup",t=>{if("Escape"==t.key){if(!v)return;_.paused&&w.active?(w.deactivate(),_.paused=!1,_.draw()):_.paused||_.waitForAnimation().then(()=>{_.paused=!0,w.activate()})}})}}}));
